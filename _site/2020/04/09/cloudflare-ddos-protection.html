<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Implementing CloudFlare&#39;s DDoS protection - Jeroen Rijks
    
  </title>

  <meta name="description" content="The Stack">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">

  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/2020/04/09/cloudflare-ddos-protection.html">
  <link rel="alternate" type="application/rss+xml" title="Jeroen Rijks" href="/feed.xml">

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">Jeroen Rijks</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/img/posts/06.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Implementing CloudFlare's DDoS protection</h1>
            
            <h2 class="subheading">Feat. Terraform</h2>
            
            <span class="meta">Posted by
              <a href="#">Jeroen Rijks</a>
              on April 09, 2020 &middot; <span class="reading-time" title="Estimated read time">
  
   5 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <h3 id="the-stack">The Stack</h3>

<p>I had set up a website on AWS S3, and managing it using Terraform. In this blog post, I will discuss how I use CloudFlare for prepare my website for the real world. The objectives are to:</p>
<ul>
  <li>Get my S3 website hosted on a public-facing domain managed in CloudFlare</li>
  <li>Increase performance of my S3-hosted website</li>
  <li>Increase security of my S3-hosted website</li>
</ul>

<p>The S3 bucket’s Terraform set-up is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_s3_bucket" "website" {
  bucket        = local.bucket_name
  acl           = private
  region        = var.aws_region
  force_destroy = false

  website {
    index_document = "index.html"
    error_document = "error.html"
  }
}
</code></pre></div></div>

<h2 id="cloudflare">CloudFlare</h2>

<p>CloudFlare acts as a content delivery network, by caching web content in lots of geographical locations, speeding up response times by serving content that has been cached physically near the end user.</p>

<p>CloudFlare also provides a firewall to monitor and filter your web traffic, based on CloudFlare-managed or self-managed rules. CloudFlare’s managed firewall rules are great because they are continuously updated using web traffic experienced by all of their clients. For example, if a CloudFlare client experiences a DDoS attack, where multiple malicious machines overload a web address with traffic (with the intent of preventing the website from serving normal users), these malicious IP addresses are added to an IP blacklist, and their requests are blocked for all CloudFlare firewall users.</p>

<h2 id="the-initial-solution">The initial solution</h2>
<p>I figured that creating a CNAME from my S3 URL to my CloudFlare domain would improve my website’s security with CloudFlare’s firewall.</p>

<h2 id="the-problem">The problem</h2>

<p>You may think that setting up an internet-facing URL (with a firewall) in CloudFlare would increase your S3-hosted website’s security, because all requests sent to the public-facing URL must make it through the firewall. However, CloudFlare is accessing the bucket contents via the bucket URL (bucket.s3-website.region.amazonaws.com), and so can anybody else. If malicious users were to discover the S3 bucket’s URL, they circumvent CloudFlare’s firewall and send requests directly to S3, and since there would be no CDN, DDoS attacks would be even easier.</p>

<h2 id="the-new-solution">The new solution</h2>

<p>To stop the S3 bucket from being publicly accessible, we want our S3 bucket policy to only give our developers and CI/CD product write access to the bucket, and only give CloudFlare can read from the bucket. This requires the following bucket configuration:</p>

<h3 id="public-access">Public access</h3>
<p>The <code class="highlighter-rouge">Block Public Access</code> settings should be enabled fully, as shown in the following Terraform module.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_s3_bucket_public_access_block" "website" {
  bucket = aws_s3_bucket.website.id

  block_public_acls        = true
  block_public_policy      = true
  ignore_public_acls       = true
  restrict_public_buckets  = true
}
</code></pre></div></div>

<h3 id="bucket-policy">Bucket policy</h3>
<p>The bucket policy will allow the <code class="highlighter-rouge">s3:GetObject</code> action for all requests coming from CloudFlare’s IP addresses. We can limit successful requests using the bucket policy’s <code class="highlighter-rouge">IpAddress</code> test, using CloudFlare’s Terraform provider to give us a big list of CloudFlare IPs.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>provider "cloudflare" {
  version = "~&gt; 2.0"
}

data "aws_iam_policy_document" "grant-cloudflare-ips" {
  statement {
    sid = "CloudflareIPsGetObject"

    actions = [
      "s3:GetObject"
    ]

    effect = "Allow"

    resources = [
      "arn:aws:s3:::${local.bucket_name}/*"
    ]

    condition {
      test     = "IpAddress"
      variable = "aws:SourceIp"
      values   = concat(data.cloudflare_ip_ranges.cloudflare.ipv4_cidr_blocks, data.cloudflare_ip_ranges.cloudflare.ipv6_cidr_blocks)
    }
  }
}
</code></pre></div></div>

<blockquote>
  <p>Note: Our developers and CI pipeline grant appropriate permissions for the S3 bucket in the policies attached to their IAM groups. If you want all of your bucket policies kept in one place, then I’d suggest adding a <code class="highlighter-rouge">principals {...}</code> section to your policy document.</p>
</blockquote>

<p>Finally, attach your policy to your bucket:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_s3_bucket_policy" "static-bucket" {
  bucket = aws_s3_bucket.website.id
  policy = data.aws_iam_policy_document.grant-cloudflare-ips-and-devs.json
}
</code></pre></div></div>

<h3 id="cloudflare-cname">CloudFlare CNAME</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data "cloudflare_zones" "zones" {
  filter {
    name  = var.cloudflare_hosted_zone
  }
}

resource "cloudflare_record" "cname" {
  zone_id = data.cloudflare_zones.zones.zones[0].id
  name    = var.hostname  ## Set this to your desired subdomain
  type    = "CNAME"
  value   = "s3-website.region.amazonaws.com"  ## If your S3 bucket has a different name to your desired subdomain name, I'd suggest creating an alias to the bucket, and pointing your CNAME at that instead.
  ttl     = var.cloudflare_cname_ttl  ## This is up to you
  proxied = true
}
</code></pre></div></div>

<h3 id="conclusion">Conclusion</h3>

<p>After applying all of the changes in Terraform, I tried to access the S3 URL, and my request was denied (as expected), since only CloudFlare’s IP addresses are whitelisted.</p>

<p><img class="img-fluid" src="/assets/img/403_S3_cloudflare.png" alt="403 error message from S3" /></p>

<p>However, accessing the CloudFlare-managed URL gave me access to the website right away.</p>


        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/2020/03/26/kube-aliases.html" data-toggle="tooltip" data-placement="top" title="Kubectl Aliases">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/2020/04/12/shared_efs_volume.html" data-toggle="tooltip" data-placement="top" title="Sharing a filesystem between multiple Kubernetes workers">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:jeroen-rijks@hotmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          <li class="list-inline-item">
            <a href="https://www.linkedin.com/in/JeroenRijks">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://github.com/JeroenRijks">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; Jeroen Rijks 2020</p>
      </div>
    </div>
  </div>
</footer>


  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>

<script src="/assets/scripts.js"></script>




<!--  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>

-->

</body>

</html>
